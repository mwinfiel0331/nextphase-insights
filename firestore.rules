rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;  // WARNING: Only for testing! Change this in production
    }
    
    match /_test/{docId} {
      allow read, write: if true;
    }

    // Helper functions for validation
    function isValidEmail(email) {
      return email.matches('^[^@]+@[^@]+\\.[^@]+$');
    }

    function isValidCompanySize(size) {
      return size in ['1-10', '11-50', '51-200', '201-500', '500+'];
    }

    function isValidIndustry(industry) {
      return industry in ['Technology', 'Healthcare', 'Finance', 'Retail', 'Manufacturing', 'Other'];
    }

    // Client collection rules
    match /clients/{clientId} {
      allow read: if true;  // Allow read for now, restrict later with auth
      allow create: if 
        request.resource.data.company_name is string &&
        request.resource.data.company_name.size() > 0 &&
        isValidIndustry(request.resource.data.industry) &&
        isValidCompanySize(request.resource.data.company_size) &&
        isValidEmail(request.resource.data.contact_email);
      allow update: if 
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['status', 'updated_at', 'pain_points', 'goals']);
    }

    // Sessions collection rules
    match /sessions/{sessionId} {
      allow read: if true;  // Allow read for now, restrict later with auth
      allow create: if 
        request.resource.data.company_id is string &&
        request.resource.data.session_date is timestamp &&
        request.resource.data.status in ['new', 'completed', 'cancelled'];
      allow update: if 
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['status', 'summary']);
    }
  }
}